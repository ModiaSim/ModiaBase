<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · ModiaBase</title><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">ModiaBase</a></span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Home</a></li><li class="is-active"><a class="tocitem" href="Tutorial.html">Tutorial</a><ul class="internal"><li><a class="tocitem" href="#.-Regular-DAEs-(Index-Zero-DAEs)"><span>1. Regular DAEs (Index Zero DAEs)</span></a></li><li><a class="tocitem" href="#.-Singular-DAEs-(Higher-Index-DAEs)"><span>2. Singular DAEs (Higher Index DAEs)</span></a></li></ul></li><li><a class="tocitem" href="DataStructures.html">Data Structures</a></li><li><a class="tocitem" href="EquationSorting.html">Equation Sorting</a></li><li><a class="tocitem" href="EquationReduction.html">Equation Reduction</a></li><li><a class="tocitem" href="TransformationToODEs.html">Transformation to ODE System</a></li><li><a class="tocitem" href="NonlinearEquations.html">Nonlinear Equations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="Tutorial.html">Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="Tutorial.html">Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ModiaSim/ModiaBase.jl/blob/main/docs/src/Tutorial.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial"><a class="docs-heading-anchor" href="#Tutorial">Tutorial</a><a id="Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial" title="Permalink"></a></h1><p>This chapter contains a short tutorial about the data structures and functions provided by package <a href="https://github.com/ModiaSim/ModiaBase.jl">ModiaBase</a>.</p><h2 id=".-Regular-DAEs-(Index-Zero-DAEs)"><a class="docs-heading-anchor" href="#.-Regular-DAEs-(Index-Zero-DAEs)">1. Regular DAEs (Index Zero DAEs)</a><a id=".-Regular-DAEs-(Index-Zero-DAEs)-1"></a><a class="docs-heading-anchor-permalink" href="#.-Regular-DAEs-(Index-Zero-DAEs)" title="Permalink"></a></h2><p>In this subsection functions are demonstrated that can be used to transform regular DAEs to ODEs.</p><p>The transformations are explained with the following simple electrical circuit (a low pass filter where the voltage source is modelled with an inner resistor):</p><p><img src="../resources/images/LowPassFilter.png" alt="Low Pass Filter"/></p><h3 id=".1-Bi-Partite-Graph"><a class="docs-heading-anchor" href="#.1-Bi-Partite-Graph">1.1 Bi-Partite Graph</a><a id=".1-Bi-Partite-Graph-1"></a><a class="docs-heading-anchor-permalink" href="#.1-Bi-Partite-Graph" title="Permalink"></a></h3><p>In a first step, the structural information of the low pass filter model is provided as incidence matrix</p><p><img src="../resources/images/LowPassFilter_IncidenceMatrix.png" alt="Incidence Matrix of Low Pass Filter"/></p><ul><li>Every <strong>column</strong> corresponds to one time-varying <strong>variable</strong>. Parameters, so variables with constant values, are not shown.</li></ul><ul><li>Every <strong>row</strong> corresponds to one <strong>equation</strong>.</li></ul><ul><li>A cell is marked (here in <em>blue</em>), if a time-varying variable is present in one equation. Variables that are appearing differentiated, such as <code>C.v</code>, are not marked because in a first analysis phase, these potential state variables are treated as known.</li></ul><p>The matrix above is called the <strong>incidence matrix</strong> or the <strong>bi-partite graph</strong> of the circuit. In ModiaBase, this matrix is represented as vector <code>G</code> of Integer vectors:</p><pre><code class="language-julia hljs"># Bi-partite graph of low pass filter
G = [ [25,27],  # equation 1 depends on variables 25,27
      [6,23],
      [4,10],
      ...,
      [27] ]</code></pre><p>This can be also made more explicit (and a bit more efficient storage) by defining the incidence matrix as:</p><pre><code class="language-julia hljs"># Bi-partite graph of low pass filter
G = Vector{Int}[ [25,27],  # equation 1 depends on variables 25,27
                 [6,23],
                 [4,10],
                 ...,
                 [27] ]</code></pre><h3 id=".2-Linear-Integer-Equations"><a class="docs-heading-anchor" href="#.2-Linear-Integer-Equations">1.2 Linear Integer Equations</a><a id=".2-Linear-Integer-Equations-1"></a><a class="docs-heading-anchor-permalink" href="#.2-Linear-Integer-Equations" title="Permalink"></a></h3><p>Object-oriented models consist of a lot of linear Integer equations, especially due to the connect-statements. The linear integer equations of <code>G</code> are identified and the corresponding linear factors are determined. With function <a href="EquationReduction.html#ModiaBase.simplifyLinearIntegerEquations!"><code>simplifyLinearIntegerEquations!</code></a> this information is used to simplify the equations by transforming the linear Integer equations with a fraction-free (exact) Gaussian elimination to a special normalized form and then perform the following simplifications:</p><ul><li>Equations of the form <code>v = 0</code> are removed and <code>v</code> is replaced by „0“ at all places where <code>v</code> occurs, and these equations are simplified.</li></ul><ul><li>Equations of the form <code>v1 = v2</code> and <code>v1 = -v2</code> are removed, <code>v1</code>  is replaced by <code>v2</code> (or <code>-v2</code>) at all places where <code>v1</code> occurs (so called <em>alias-variables</em>), and these equations are simplified.</li></ul><ul><li><em>Redundant equations</em> are removed.</li></ul><ul><li>Variables that appear <em>only</em> in the linear Integer equations (and in no other equations) are set to zero, if they can be <em>arbitrarily selected</em>. For example, if an electrical circuit is not grounded, then one of the electrical potentials is arbitrarily set to zero.</li></ul><ul><li>State constraints are made structurally visible.</li></ul><p>After applying <a href="EquationReduction.html#ModiaBase.simplifyLinearIntegerEquations!"><code>simplifyLinearIntegerEquations!</code></a> to the low pass filter circuit, the incidence matrix is simplified to</p><p><img src="../resources/images/LowPassFilterReduced_IncidenceMatrix.png" alt="Incidence Matrix of Low Pass Filter"/></p><pre><code class="language-julia hljs"># Bi-partite graph of simplified low pass filter
G = Vector{Int}[ [1,2,4],
                 [1,7],
                 [3,4],
                 [3,7],
                 [6,7],
                 [2] ]

# Eliminated variables
R.i        = -(V.p.i)
ground.p.v = 0
R.p.i      = -(V.p.i)
R.n.v      = C.v
V.n.i      = -(V.p.i)
V.n.v      = 0
V.p.v      = Ri.n.v
Ri.p.i     = V.p.i
C.n.v      = 0
C.p.v      = C.v
Ri.p.v     = R.p.v
C.n.i      = V.p.i
V.i        = V.p.i
R.n.i      = V.p.i
C.p.i      = -(V.p.i)
ground.p.i = 0
C.i        = -(V.p.i)
Ri.i       = V.p.i
V.v        = Ri.n.v
Ri.n.i     = -(V.p.i)</code></pre><h3 id=".3-Assignment"><a class="docs-heading-anchor" href="#.3-Assignment">1.3 Assignment</a><a id=".3-Assignment-1"></a><a class="docs-heading-anchor-permalink" href="#.3-Assignment" title="Permalink"></a></h3><p>In a follow-up step, an assignment is made (also called matching), to associate one variable uniquely with one equation:</p><p><img src="../resources/images/LowPassFilterReduced_Matching.png" alt="Matched IIncidence Matrix of Low Pass Filter"/></p><ul><li><em>Red</em> marks show the assigned variables.</li><li><em>Blue</em> marks show if a variable is part of the respective equation</li></ul><p>The assignment is computed with function <a href="EquationSorting.html#ModiaBase.BLTandPantelides.matching"><code>ModiaBase.matching</code></a> returning a vector <code>assign</code>:</p><pre><code class="language-julia hljs">using ModiaBase
vActive    = fill(true,7)
vActive[5] = false    # state C.v is known
assign     = matching(G, 7, vActive)

# assign = [2,6,3,1,0,5,4]</code></pre><p>The meaning of vector <code>assign</code> is that</p><ul><li>Variable 1 is solved from equation 2,</li><li>Variable 2 is solved from equation 6,</li><li>etc.</li></ul><h3 id=".4-Sorting"><a class="docs-heading-anchor" href="#.4-Sorting">1.4 Sorting</a><a id=".4-Sorting-1"></a><a class="docs-heading-anchor-permalink" href="#.4-Sorting" title="Permalink"></a></h3><p>In a follow-up step, equations are sorted and algebraic loops determined (= Block Lower Triangular transformation):</p><p><img src="../resources/images/LowPassFilterReduced_BLT.png" alt="Incidence Matrix of sorted equations of Low Pass Filter"/></p><ul><li><em>Red</em> marks show the assigned variables.</li><li><em>Blue</em> marks show if a variable is part of the respective equation</li><li>A <em>grey</em> area marks an algebraic loop.</li></ul><p>The sorting is computed with function <a href="EquationSorting.html#ModiaBase.BLTandPantelides.BLT"><code>ModiaBase.BLT</code></a>:</p><pre><code class="language-julia hljs">using ModiaBase
blt = BLT(G, assign)

#=
    blt = [ [6],
            [3,4,2,1],
            [5] ]
=#</code></pre><p>The meaning is for example that the second BLT block consists of equations 3,4,2,1 and these equations form an algebraic loop.</p><h3 id=".5-Reducing-sizes-of-equation-systems"><a class="docs-heading-anchor" href="#.5-Reducing-sizes-of-equation-systems">1.5 Reducing sizes of equation systems</a><a id=".5-Reducing-sizes-of-equation-systems-1"></a><a class="docs-heading-anchor-permalink" href="#.5-Reducing-sizes-of-equation-systems" title="Permalink"></a></h3><p>In a follow-up step, the sizes of equation systems are reduced by variable substitution (= tearing). Applying <a href="EquationReduction.html#ModiaBase.tearEquations!"><code>ModiaBase.tearEquations!</code></a> to the  low pass filter circuit, reduces the dimension of BLT block 2 from size 4 to size 1 resulting in the following equation system:</p><pre><code class="language-julia hljs"># iteration variables (inputs): C.i
# residual variables (outputs): residual

R.v := R.R*C.i
R.i.v := -Ri.R*C.i
R.p.v := Ri.v + V.v
residual := R.v - R.p.v + C.v</code></pre><h3 id=".6-Generation-of-AST"><a class="docs-heading-anchor" href="#.6-Generation-of-AST">1.6 Generation of AST</a><a id=".6-Generation-of-AST-1"></a><a class="docs-heading-anchor-permalink" href="#.6-Generation-of-AST" title="Permalink"></a></h3><p>In a final step, the AST (Abstract Syntax Tree) of the model is generated. Hereby, it is determined that the equation system of section 1.4 and 1.5 is linear in the iteration variable (<code>C.i</code>) and an AST is generated to build-up a linear equation system <code>A*C.i = b</code> and solve this system numerically with an LU decomposition whenever the AST is called (if the equation system has size 1,  a simple division is used instead of calling a linear equation solver). Applying <code>Modia.getSortedAndSolvedAST</code> results basically in a function <code>getDerivatives</code> that can be solved with the many ODE integrators of <a href="https://github.com/SciML/DifferentialEquations.jl">DifferentialEquations.jl</a>:</p><pre><code class="language-julia hljs">function getDerivatives(_der_x, _x, _m, _time)::Nothing
    _m.time = ModiaLang.getValue(_time)
    _m.nGetDerivatives += 1
    instantiatedModel = _m
    _p = _m.evaluatedParameters
    _leq_mode = nothing
    time = _time
    var&quot;C.v&quot; = _x[1]
    var&quot;V.v&quot; = (_p[:V])[:V]
    begin
        local var&quot;C.i&quot;, var&quot;R.v&quot;, var&quot;Ri.v&quot;, var&quot;R.p.v&quot;
        _leq_mode = _m.linearEquations[1]
        _leq_mode.mode = -2
        while ModiaBase.LinearEquationsIteration!(_leq_mode, _m.isInitial, _m.time, _m.timer)
            var&quot;C.i&quot; = _leq_mode.vTear_value[1]
            var&quot;R.v&quot; = (_p[:R])[:R] * var&quot;C.i&quot;
            var&quot;Ri.v&quot; = (_p[:Ri])[:R] * -var&quot;C.i&quot;
            var&quot;R.p.v&quot; = var&quot;Ri.v&quot; + var&quot;V.v&quot;
            _leq_mode.residual_value[1] = (var&quot;R.v&quot; + -1var&quot;R.p.v&quot;) + var&quot;C.v&quot;
        end
        _leq_mode = nothing
    end
    var&quot;der(C.v)&quot; = var&quot;C.i&quot; / (_p[:C])[:C]
    _der_x[1] = var&quot;der(C.v)&quot;
    if _m.storeResult
        ModiaLang.addToResult!(_m, _der_x, time, var&quot;R.v&quot;, var&quot;R.p.v&quot;, var&quot;Ri.v&quot;, var&quot;C.i&quot;, var&quot;V.v&quot;)
    end
    return nothing
end</code></pre><h2 id=".-Singular-DAEs-(Higher-Index-DAEs)"><a class="docs-heading-anchor" href="#.-Singular-DAEs-(Higher-Index-DAEs)">2. Singular DAEs (Higher Index DAEs)</a><a id=".-Singular-DAEs-(Higher-Index-DAEs)-1"></a><a class="docs-heading-anchor-permalink" href="#.-Singular-DAEs-(Higher-Index-DAEs)" title="Permalink"></a></h2><p>xxx</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="index.html">« Home</a><a class="docs-footer-nextpage" href="DataStructures.html">Data Structures »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Saturday 3 June 2023 11:47">Saturday 3 June 2023</span>. Using Julia version 1.9.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
